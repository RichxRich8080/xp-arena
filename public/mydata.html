<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Data • XP ARENA</title>
  <meta name="description" content="Export your XP ARENA data: vault, presets and history.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">
</head>
<body class="fade-in">
  <nav class="navbar"></nav>
  <div class="container" style="max-width:900px">
    <div class="page-header" data-parallax="8">
      <h1 class="text-neon">My Data</h1>
      <p>Review and export your Vault, Presets and History.</p>
    </div>

    <div class="form-card">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:1rem">
        <button class="btn-secondary" id="exportAllBtn" style="width:auto">Export All JSON</button>
        <a class="btn-secondary" href="profile.html" style="width:auto">Go to Profile</a>
      </div>
      <div id="dataSections">
        <h3 style="margin:1rem 0">Vault</h3>
        <div id="vaultList" style="display:grid;gap:10px"></div>
        <h3 style="margin:1.5rem 0 1rem">Presets</h3>
        <div id="presetsList" style="display:grid;gap:10px"></div>
        <h3 style="margin:1.5rem 0 1rem">History</h3>
        <div id="historyList" style="display:grid;gap:10px"></div>
      </div>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-top:1rem">Note: deletion from this page will be added soon. For now, export your data or manage items from your Profile.</p>
    </div>
  </div>

  <nav class="bottom-nav"></nav>
  <script src="js/auth.js"></script>
  <script src="js/user.js"></script>
  <script src="js/layout.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!Auth.isLoggedIn()) { window.location.href = 'login.html'; return; }
      renderData();
      const exportBtn = document.getElementById('exportAllBtn');
      exportBtn.addEventListener('click', () => {
        const stats = User.getStats() || {};
        const data = {
          vault: stats.vault || [],
          presets: stats.presets || [],
          history: stats.sensitivityHistory || []
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'xp-arena-data.json';
        a.click();
        URL.revokeObjectURL(url);
        if (window.Toast) Toast.show('Data exported!', 'success');
      });
    });

    function renderData() {
      const stats = User.getStats() || {};
      const vault = stats.vault || [];
      const presets = stats.presets || [];
      const history = stats.sensitivityHistory || [];

      const vaultList = document.getElementById('vaultList');
      const presetsList = document.getElementById('presetsList');
      const historyList = document.getElementById('historyList');

      vaultList.innerHTML = vault.length ? vault.map(v => `
        <div class="form-card" style="padding:1rem;border-left:4px solid var(--accent)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${v.device || 'Device'}</strong>
              <div style="font-size:0.8rem;color:var(--text-muted)">${new Date(v.timestamp).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <div style="font-size:0.85rem;color:var(--text-muted)">Gen: <span style="color:#fff">${v.general || '-'}</span></div>
              <button class="btn-secondary" data-del="vault" data-id="${v.id}" style="width:auto;padding:0.4rem 0.8rem">Delete</button>
            </div>
          </div>
        </div>
      `).join('') : `<p style="color:var(--text-muted)">No items in Vault.</p>`;

      presetsList.innerHTML = presets.length ? presets.map(p => `
        <div class="form-card" style="padding:1rem;border-left:4px solid #bf00ff">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>⭐ ${p.name}</strong>
              <div style="font-size:0.8rem;color:var(--text-muted)">${new Date(p.timestamp).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <div style="font-size:0.85rem;color:var(--text-muted)">${p.device || ''}</div>
              <button class="btn-secondary" data-del="preset" data-id="${p.id}" style="width:auto;padding:0.4rem 0.8rem">Delete</button>
            </div>
          </div>
        </div>
      `).join('') : `<p style="color:var(--text-muted)">No presets saved.</p>`;

      historyList.innerHTML = history.length ? history.map(h => `
        <div class="form-card" style="padding:1rem;border-left:4px solid rgba(255,255,255,0.2)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${h.device || 'Device'}</strong>
              <div style="font-size:0.8rem;color:var(--text-muted)">${new Date(h.timestamp).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <div style="font-size:0.85rem;color:var(--text-muted)">Center: <span style="color:#fff">${h.general_mid || '-'}</span></div>
              <button class="btn-secondary" data-del="history" data-id="${h.id}" style="width:auto;padding:0.4rem 0.8rem">Delete</button>
            </div>
          </div>
        </div>
      `).join('') : `<p style="color:var(--text-muted)">No history yet.</p>`;

      document.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const type = btn.getAttribute('data-del');
          const id = parseInt(btn.getAttribute('data-id'), 10);
          if (!id) return;
          if (type === 'vault') await User.deleteVault(id);
          if (type === 'preset') await User.deletePreset(id);
          if (type === 'history') await User.deleteHistory(id);
          renderData();
        });
      });
    }
  </script>
</body>
</html>
