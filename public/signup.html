<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up • XP ARENA</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">
</head>

<body class="fade-in">
    <nav class="navbar"></nav>
    <div class="auth-container">
        <h1>Create Account</h1>
        <div id="error-msg" class="error-msg"></div>
        <form id="signupForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="Choose a username" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="you@example.com" required>
            </div>
            <div class="form-group" style="position: relative;">
                <label>Password</label>
                <div style="position: relative;">
                    <input type="password" id="password" placeholder="••••••••" required
                        style="padding-right: 40px; width: 100%;">
                    <i class="fas fa-eye" id="togglePassword"
                        style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);"></i>
                </div>
                <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 4px;">Min 8
                    chars, 1 uppercase, 1 number, 1 special character.</small>
            </div>
            <div class="form-group" style="position: relative;">
                <label>Confirm Password</label>
                <div style="position: relative;">
                    <input type="password" id="confirmPassword" placeholder="••••••••" required
                        style="padding-right: 40px; width: 100%;">
                    <i class="fas fa-eye" id="toggleConfirm"
                        style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);"></i>
                </div>
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="terms" required style="width: auto;">
                <label for="terms" style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">I agree to the <a
                        href="#" class="text-neon" style="text-decoration: underline;">Terms & Conditions</a></label>
            </div>

            <button type="submit" class="btn-auth glow-neon">Sign Up</button>
        </form>
        <div style="margin-top: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">
            Already have an account? <a href="login.html" class="text-neon">Login</a>
        </div>
    </div>
    <nav class="bottom-nav"></nav>

    <script src="js/auth.js"></script>
    <script src="js/user.js"></script>
    <script src="js/layout.js"></script>
    <script src="js/app.js"></script>
    <script>
        document.getElementById('togglePassword').addEventListener('click', function () {
            const pwd = document.getElementById('password');
            const type = pwd.getAttribute('type') === 'password' ? 'text' : 'password';
            pwd.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });

        document.getElementById('toggleConfirm').addEventListener('click', function () {
            const confirm = document.getElementById('confirmPassword');
            const type = confirm.getAttribute('type') === 'password' ? 'text' : 'password';
            confirm.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const confirm = document.getElementById('confirmPassword').value;
            const err = document.getElementById('error-msg');

            // Custom validation logic
            const passRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            if (!passRegex.test(pass)) {
                err.textContent = "Password must be at least 8 characters long and include 1 uppercase letter, 1 number, and 1 special character (@$!%*?&).";
                err.style.display = 'block';
                return;
            }

            if (pass !== confirm) {
                err.textContent = "Passwords do not match";
                err.style.display = 'block';
                return;
            }

            const btn = document.querySelector('.btn-auth');
            btn.textContent = 'Creating Account...';
            btn.disabled = true;

            const result = await Auth.signup(user, email, pass);
            if (result.success) {
                // Handle referral reward
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode) {
                    const allKeys = Object.keys(localStorage);
                    allKeys.forEach(key => {
                        if (key.startsWith('xp_stats_')) {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                if (data && data.referralCode === refCode) {
                                    data.axp = (data.axp || 0) + 200;
                                    data.referralCount = (data.referralCount || 0) + 1;
                                    if (!data.activities) data.activities = [];
                                    data.activities.unshift({ text: `Referral reward: ${user} signed up using your code!`, timestamp: new Date().toISOString() });
                                    localStorage.setItem(key, JSON.stringify(data));
                                }
                            } catch (e) { }
                        }
                    });
                }

                // Show Success Overlay instead of redirect
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000;
                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                    backdrop-filter: blur(10px); animation: fadeIn 0.5s ease forwards;
                `;
                overlay.innerHTML = `
                    <div style="text-align: center; max-width: 500px; padding: 2rem;">
                        <i class="fas fa-check-circle" style="font-size: 5rem; color: var(--success); margin-bottom: 1rem; filter: drop-shadow(0 0 20px var(--success)); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;"></i>
                        <h1 style="color: #fff; font-size: 2.5rem; margin-bottom: 0.5rem;">Account Created!</h1>
                        <p style="color: var(--text-muted); font-size: 1.1rem; margin-bottom: 2rem;">Welcome to XP Arena, <span style="color: var(--accent); font-weight: 800;">${user}</span>.</p>
                        
                        <div style="background: rgba(0,229,255,0.1); border: 1px solid var(--accent); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 0 20px rgba(0,229,255,0.2);">
                            <div style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase;">Starting Bonus</div>
                            <div style="font-size: 2.5rem; font-weight: 900; color: var(--accent); text-shadow: 0 0 10px var(--accent-glow);">+100 AXP</div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.location.href='profile.html'" class="btn-primary" style="width: auto; padding: 1rem 2rem;">View Profile</button>
                            <button onclick="window.location.href='tool.html'" class="btn-secondary" style="width: auto; padding: 1rem 2rem;">Calibrate Sensitivity</button>
                        </div>
                    </div>
                `;

                // Add popIn animation definition if not present
                if (!document.getElementById('popInStyle')) {
                    const style = document.createElement('style');
                    style.id = 'popInStyle';
                    style.innerHTML = `@keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }`;
                    document.head.appendChild(style);
                }

                document.body.appendChild(overlay);
                if (window.Celebration) Celebration.fire();

                // AXP is now awarded securely by the backend API upon registration
                setTimeout(() => {
                    // Just wait for animation before redirect
                }, 500);

            } else {
                const err = document.getElementById('error-msg');
                err.textContent = result.message;
                err.style.display = 'block';
                btn.textContent = 'Sign Up';
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>